<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Lizelong——李泽龙的个人博客，学习资料，小知识，小技巧，记录成长。">

    <link rel="stylesheet" type="text/css" media="screen" href="css/stylesheet.css">
    <!-- 引入bootstrap文件 -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <script src="./js/jquery1.11.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>

    <title>有点意思</title>
  </head>

  <body>
    <!-- HEADER -->
    <div id="header_wrap" class="outer navbar-fixed-top">
        <header class="head">
          <h1 id="project_tagline">穷则独善其身，富则妻妾成群</h1>
        </header>
    </div>

    <div class="position-btn text-info" onclick="pao(true)"><i class="glyphicon glyphicon-arrow-up"></i>顶部</div>
    <div class="position-btn text-info" onclick="pao(false)" style="margin-top:50px"><i class="glyphicon glyphicon-arrow-down"></i>底部</div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <div class="inner"> 
        <a href="index.html" class="btn btn-info">返回列表</a> 
      </div>

      <div class="inner" id="content"></div>

      <div class="inner" id="page"></div>

      <div class="inner" id="review">
        <a class="btn btn-warning">评论列表</a>
        <ul class="list-unstyled review-list">
          <!-- <li>
            <span>匿名：</span>
            <strong>好！！！内容！！！学习了！！！好！！！内容！！！学习了！！！好！！！内容！！！学习了！！！好！！！内容！！！学习了！！！好！！！内容！！！学习了！！！好！！！内容！！！学习了！！！<button class="btn btn-sm btn-primary">回复</button></strong>
            <ul>
              <li>回复：哈哈哈哈哈哈哈哈啊哈</li>
              <li>回复：哈哈哈哈哈哈哈哈啊哈</li>
              <li>回复：哈哈哈哈哈哈哈哈啊哈</li>
              <li>回复：哈哈哈哈哈哈哈哈啊哈</li>
            </ul>
          </li> -->
        </ul>

        <a class="btn btn-info" style="margin-bottom:15px">说两句</a>
        <form style="margin-left:20px" onsubmit="return review(this)">
          <input type="text" name="name" placeholder="昵称" /><br>
          <textarea name="content" placeholder="评论内容" require cols="90" rows="3"></textarea>
          <button class="btn btn-sm btn-primary">写好了</button>
        </form>
      </div>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer navbar-fixed-bottom">
      <footer class="inner">
        <p>@本博客解释权归 <a href="http://www.copydm.com" target="_blank">李大爷</a> 所有</p>
      </footer>
    </div>
  
  <!-- 小模态框 -->
    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <form onsubmit="return reply(this)">
            <input type="hidden" name="rid" />
            <input type="text" class="form-control" name="name" placeholder="昵称">
            <textarea class="form-control" rows="3" placeholder="回复内容"></textarea>
            <button class="btn btn-xs btn-primary center-block">写好了</button>
          </form>
        </div>
      </div>
    </div>

  </body>
</html>


<script>
//模拟PHP获取URL传的参数，比如$_GET['id']
var $_GET = (function(){
  var url = window.document.location.href.toString();
  var u = url.split("?");
  if(typeof(u[1]) == "string"){
      u = u[1].split("&");
      var get = {};
      for(var i in u){
          var j = u[i].split("=");
          get[j[0]] = j[1];
      }
      return get;
  } else {
      return {};
  }
})();

//获取评论者的浏览器信息
var useragent = window.navigator.userAgent;

//获取屏幕尺寸
var size = window.screen.width + ' * ' + window.screen.height;

//给评论的li绑定鼠标事件
$('.review-list').on('mouseenter', 'li', function(){
  if ($(this).attr('rid')) {
    $(this).find('strong:last').after('<button class="btn btn-xs pull-right btn-primary" onclick="replyInfo('+ $(this).attr('rid') +')">回复</button>');
  }
})
$('.review-list').on('mouseleave', 'li', function(){
  $(this).find('button').remove();
})

//显示模态框
function replyInfo(rid) {
  $('input[name=rid]').val(rid);
  $('.modal').modal({
    keyboard: false
  })
}

//处理回复操作
function reply(obj){
  var content = $(obj).find('textarea').val();
  if (content.length < 3) {
    alert('多说两个字吧');
    return false;
  };

  //获取回复者昵称
  var name = $(obj).find('input[name=name]').val() || '匿名';

  //获取review评论ID
  var rid = $(obj).find('input[name=rid]').val();

  $(obj).find('button').attr('disabled', true);
  $.ajax({
    url: 'http://www.copydm.com/blog/index.php/Home/Index/reply',
    data: {rid:rid, name:name, content:content, browser: useragent, screen: size},
    type: 'post',
    dataType: 'json', 
    success: function(res){
      if (res['status']) {
        //添加回复到页面
        if ($('li[rid='+ rid +'] ul li').length > 0) {
          $('li[rid='+ rid +'] ul').append('<li>'+ name +'： '+ content +'</li>');
        } else {
          $('li[rid='+ rid +'] ul').append('<li class="reply-first">回复：</li><li>'+ name +'： '+ content +'</li>');
        }

        //恢复按钮状态
        $(obj).find('button').attr('disabled', false);
        //清除表单数据
        $('.modal').find('form')[0].reset();
        //隐藏模态框
        $('.modal').modal('hide');
      } else {
        alert(res['msg']);
      }
    }
  })
  return false;
}



//处理评论
function review(obj){
  var content = $(obj).find('textarea').val();
  if (content.length < 5) {
    alert('多说两个字嘛~~~');
    return false;
  }
  //获取评论者昵称
  var name = $(obj).find('input[name=name]').val() || '匿名';

  $(obj).find('button').attr('disabled', true);
  //ajax提交添加数据
  $.ajax({
    url: 'http://www.copydm.com/blog/index.php/Home/Index/review',
    type: 'post',
    data: {pid:$_GET['id'], name: name, content:content, browser: useragent, screen: size},
    dataType: 'json',
    success: function(res){
      if (res.status) {
        var floor = $('.review-list > li:last .small').text();
        if (floor) {
          floor = parseInt(floor.substr(1)) + 1;
        } else {
          floor = 1;
        }
        //将评论的内容增加到页面上
        var str = '<li rid="'+ res['id'] +'"><strong class="text-danger small">#'+ floor +' </strong><span>'+ name +'：</span><br><strong>　　'+ content +'</strong><ul></ul></li>';
        //判断是否是沙发
        if (floor == 1) {
          $('.review-list').html(str);
        } else {
          $('.review-list').append(str);
        }

        //回复按钮状态
        $(obj).find('button').attr('disabled', false);
        //清空表单
        $('form')[0].reset();
      } else {
        alert(res.msg);
      }
    }
  })
  return false;
}

//还得去查询当前帖子的评论和回复。。。
$.ajax({
  url: 'http://www.copydm.com/blog/index.php/Home/Index/getView',
  type: 'post',
  data: {pid: $_GET['id']},
  dataType: 'json',
  success: function(res){
    var str = '';
    if (res) {
      for (var i = 0,len = res.length; i < len; i++) {
        str += '<li rid="'+ res[i]['id'] +'"><strong class="text-danger small">#'+ (i+1) +' </strong><span>'+ res[i]['name'] +'：</span><br><strong>　　'+ res[i]['content'] +'</strong>';
        //评论下的回复
        str += '<ul>';
        if (res[i]['reply']) {
          str += '<li class="reply-first">回复：</li>';
          for (var j = 0, leng = res[i]['reply'].length; j < leng; j++) {
            str += '<li>'+ res[i]['reply'][j]['name'] +'：'+ res[i]['reply'][j]['content'] +'</li>';
          };
        }
        str += '</ul></li>';
      }

    } else {
      str += '<li><strong>暂无评论，快来抢沙发吧~~~</strong></li>';
    }
    $('.review-list').html(str);
  }
})

//滚动显示到顶和到底按钮
$(window).scroll(function(){
  if ($(window).scrollTop() > 10) {
    $('.position-btn').show(800);
  } else {
    $('.position-btn').hide(800);
  }
})

//点击跑动滚动条
function pao(flag) {
  if (flag) {
    $('html,body').animate({'scrollTop': '0px'}, 1000);
  } else {
    $('html,body').animate({'scrollTop': $(document).height() + 'px'}, 1000);
  }
}

//获取内容
$.ajax({
  url: './post/'+ $_GET['id'] +'.html',
  type: 'get',
  success: function(res){
    $('#content').html(res);
    //获取翻页标题
    getTitle();
  },
  error: function(){
    $('#main_content_wrap').html('<section class="inner main_content" style="font-size:25px"><i class="glyphicon glyphicon-share-alt"></i> <a href="index.html">暂时没有内容</a></section>');
  }
})

//获取标题信息
function getTitle() {
  //ajax请求
  $.get('./title.html', '', function(res){
    var str = '<section class="inner main_content"> <ul class="pager">';
    for (var i = 0; i < res.length; i++) {
      if (res[i]['id'] == $_GET['id']) {
        //修改标题和描述
        document.title = res[i]['title']; 
        $('meta[name=description]').attr('content', res[i]['des']);

        //获取上一条的标题
        if ($_GET['id'] <= 1) {
          str += '<li class="previous disabled"><a><span>&larr;</span>没有了</a></li>';
        } else {
          str += '<li class="previous"><a href="?id='+ res[i+1]['id'] +'"><span>&larr;</span> '+ res[i+1]['title'] +'</a></li>';
        }

        //获取下一条的标题
        if ($_GET['id'] >= res.length) {
          str += '<li class="next disabled"><a>没有了<span>&rarr;</span></a></li></ul></section>';
        } else {
          str += '<li class="next"><a href="?id='+ res[i-1]['id'] +'">'+ res[i-1]['title'] +'<span>&rarr;</span></a> </li> </ul> </section>';
        }
      }
    }
    $('#page').html(str);
  }, 'json');
}

//随机显示标题
var title = [
  '穷则独善其身，富则妻妾成群',
  '君子成人之美，小人夺人所爱',
  '英雄宝刀未老，老娘风韵犹存',
  '天生我材必有用，老鼠儿子会打洞',
  '书到用时方恨少，钱到月底不够花',
  '两个黄鹂鸣翠柳，一行白鹭上西天',
  '问君能有几多愁，恰似一群太监上青楼',
  '相爱没有那么容易，每个人都有他的手机',
  '如果天黑之前来得及，我要挖了你的眼睛',
  '你所有为人称道的美丽，都有PS的痕迹',
  '想飞上天和太阳肩并肩',
  '大爷听过我的歌，小伙亲过我的脸',
  '答应我你从此不在深夜里排队',
  '我们坐在高高的骨灰旁边～～',
  '千万别说你一无所有，至少你还有病啊'
];
var index = Math.ceil(Math.random() * title.length);
$('#project_tagline').html(title[index]);
</script>